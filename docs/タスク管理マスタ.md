# タスク管理マスタの仕様

タスク管理マスタは、tools/task_master.pyとする。

引数には、待受ポート番号を与える。ただしデフォルト設定を34567とする。

さらにオプショナル引数でルートディレクトリパスを指定する。なお、デフォルトのルートディレクトリはスクリプトを実行した時のカレントディレクトリとする。

以降に記載する.tasksのディレクトリは、ルートディレクトリに配置されているものとする。



別スレッドやタスクワーカーとやり取りするメッセージは、メッセージフォーマット.mdの仕様に従う。

タスク管理マスタを起動すると、すぐにメインループに入ると同時に、タイマースレッドを起動する。

メインループでは、イベントやメッセージの待ち受けと、ワーカーの動作状態の管理を実施する。

メインループでは、以下のイベントを待つ。

* タスクワーカーからのTCP接続受け入れ（bindするIPは0.0.0.0とする）
* タスクワーカーからの各種メッセージの受信（JOIN、DONE/FAILED、LEAVE、CHECK_ACK）
* タイマースレッドから発行されるタイマーイベントメッセージ（TIMER）の受信
* 別スレッドからのメッセージ受信（COMPLETED、DISCONNECT、TIMEOUT_CHECK）

タスク管理マスタのメインループ中に、Ctrl-C（SIG_TERM）が発生したら、待ち受けループを脱出して、タスク管理マスタ終了処理を実施する。



タイマースレッドは、定期的にタイマーイベントメッセージをメインループに送信する。デフォルト設定は10秒ごととする。

タイマースレッドは、メインループが終了するまで生存する。



タスク管理マスタは、参入しているタスクワーカーごとに、接続状態およびタスク稼働状態をワーカーオブジェクトで管理する。

ワーカーオブジェクトでは、以下の情報を管理する。

* コネクションに紐づくソケット情報
* ワーカーID
* 対応中の.tasks/working/のファイル名
* 稼働状態（idle/requesting/working/disconnecting）
* リクエスト情報配列（複数のリクエスト情報を格納できるようにする）
  * リクエスト情報は、リクエストIDとタイムアウト時刻の組みで表される


メインループで、タスクワーカーから参入メッセージ（JOIN）を受信したら、当該タスクワーカーのワーカーオブジェクトを生成し、その後、参入応答メッセージを返答する。なお、参入メッセージには、type=JOINとmsg=ワーカーIDが含まれている。参入応答メッセージにはtype=JOIN_ACKを送る（msgは空文字でよい）。

ワーカーオブジェクトのタスク稼働状態の初期値は「idle」とする。



何らかのイベントが起こるたびに、まだ.tasks/pending/の下にファイルが残っていないかを確認し、残っていれば、以下のタスク依頼処理を実施する。

タスク依頼処理は、ワーカーオブジェクト群をチェックして、タスク稼働状態が「idle」のものがあった場合に、以下の処理を実施する。idleのものがなければ、処理を終了する。

* .tasks/pending/の中から1つファイルを取り出して、.tasks/working/に移動する
* 稼働状態がidleになっているワーカオブジェクトのソケットに対して、今.tasks/working/に移動したタスクプロンプトの実行を依頼するメッセージ（REQUEST）を送る。メッセージには、リクエストID（乱数）とプロンプトテキストを含める
* そのワーカーオブジェクトの稼働状態をrequestingに、リクエスト情報（タイムアウト時刻を現在時刻＋3秒と、依頼に含めたリクエストID）を追加する。
* そのワーカーIDとリクエスト情報を引数として、タイムアウト監視スレッドを起動する。

メインループが実行依頼メッセージに対する返答（REQUEST_ACK）を受信すれば、該当するワーカーオブジェクトの稼働状態をworkingに変更し、該当するリクエスト情報を配列から削除する。（REQUEST_ACKにはリクエストIDが含まれる）

タイムアウト監視スレッドは、指定された秒数だけ経ったらタイムアウト確認メッセージ（TIMEOUT_CHECK）をメインループに送信し、処理を終了する。なお、タイムアウト確認メッセージには、リクエストIDを載せる。

メインループがタイムアウト確認メッセージ（TIMEOUT_CHECK）を受け取ったら、ワーカーオブジェクトの中から、タイムアウト確認メッセージに含まれているリクエストIDをリクエスト情報の中に持つものを取得する。合致するオブジェクトがなければ（既にREQUEST_ACKで削除済みのため）何もしない。取得できた場合は、現在時刻が該当するリクエスト情報のタイムアウト時刻を過ぎていれば、該当するリクエスト情報を配列から削除し、ワーカーオブジェクトに対してワーカー切断処理を実施する。



メインループがタスクワーカーから受け取った結果報告メッセージのtypeがDONEだった場合は、.tasks/working/の下の該当タスクプロンプトファイルを.tasks/done/に移動する。結果報告メッセージのtypeがFAILEDだった場合は、.tasks/failed/に移動する。また、当該タスクワーカーのタスク稼働状態を「idle」に変更する。



COMPLETEDメッセージ（type=COMPLETED）を受信した場合は、メインループを抜けて、タスク管理マスタ終了処理を実施する。

メインループがタスクワーカーから離脱メッセージ（LEAVE）を受信した場合、またはタスクワーカーとのTCP接続が切れた場合、該当するワーカーオブジェクトに対してワーカー切断処理を実施する。。



ワーカー切断処理は、ワーカーオブジェクトの稼働状態がworkingだった場合、.tasks/working/以下にある実施中のプロンプトファイルを、.tasks/pending/に移動する。また、その時点での稼働状態に関わらず、稼働状態をexitingにセットし、ワーカーオブジェクトを引数としてワーカー切断スレッドを起動する。

ワーカー切断スレッドは、ワーカーオブジェクト内のソケット情報を使って、ワーカーとのTCP接続を切断する。切断が完了したら、メインループに、切断メッセージ（DISCONNECT）を送信し、ワーカー切断スレッドを終了する。切断メッセージには、ワーカーIDを載せる。

ワーカー切断スレッドには切断タイムアウトを設け、5秒たっても戻ってこなかった場合も、強制的にメインループに切断メッセージ（DISCONNECT）を送信し、ワーカー切断スレッドを終了する。

メインループがDISCONNECTメッセージを受信したら、そこに書かれているワーカーIDを持つワーカーオブジェクトを削除する。



タイマーイベントメッセージを受信すると、以下の処理を実施する。

* .tasks/pending/および.tasks/working/以下のファイル数のチェック

* タスクワーカーの接続状態のチェック



ファイル数のチェックでは、.tasks/pending/と.tasks/working/以下のファイル数を数え、ファイル数の合計が0だった場合、COMPLETEDメッセージをメインループに送信する。



タスクワーカーの接続状態のチェックは、参入しているワーカーそれぞれに対してヘルスチェックメッセージを送る。ヘルスチェックメッセージはtype=CHECK、req_idはリクエストID（乱数）とする。

それぞれのワーカーにヘルスチェックメッセージを送信する際に、対象のワーカーオブジェクトのリクエスト情報として、リクエストIDと現在時刻＋3秒のタイムアウト時刻を追記する。そのリクエスト情報を引数として、タイムアウト監視スレッドを起動する。

送信先となるワーカーとのコネクションが切断していて、ヘルスチェックの送信に失敗してしまった場合は、そのワーカーオブジェクトに対してワーカー切断処理を実施する。

メインループがヘルスチェックの応答（CHECK_ACK）を受信すると、メッセージに書かれたリクエストIDをもつワーカーオブジェクトを取得し、該当するリクエストIDを持つリクエスト情報を削除する。



タスク管理マスタ終了処理では、合計稼働時間、全タスク数、成功タスク数、失敗タスク数を表示するとともに、全てのTCPコネクションを切断し、タスク管理マスタを終了する。

コネクションの切断タイムアウトを10秒とし、タイムアウトしたら、プログラムを強制終了する。切断タイムアウトをブロックしないように注意する。

タスク管理マスタ終了処理中にCtrl-C（SIG_TERM）が発生したら、即座にプログラムを終了する。



### タイムアウト処理の考え方

1. REQUEST送信時: リクエスト情報を配列に追加、タイムアウト監視スレッド起動
2. REQUEST_ACK受信時: 稼働状態をworkingに変更、リクエスト情報を配列から削除
3. TIMEOUT_CHECK受信時
   * リクエスト情報が存在しない場合（ACKで既に削除済み）→ 何もしない
   * リクエスト情報が存在する場合（ACK未受信）→ タイムアウト判定して切断処理
